<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		
		<style type="text/css"></style>

		<script src="https://d3js.org/d3.v5.js"></script>
		<script src="https://d3js.org/topojson.v2.min.js"></script>
		<script src="https://d3js.org/d3-geo.v1.min.js"></script>
		<script src="../build/d3-geogrid.js"></script>
	</head>
	<body>
		<svg width="480", height="300"></svg>
		<script type="text/javascript">
			
			Promise.all([
					d3.json("data/us-10m.v1.json"),
					d3.tsv("data/us-state-names.tsv")
				])
				.then(function(source) {
					var names = source[1];

					var topology = source[0];
					var objects = topology.objects.states;

					var geo = topojson.feature(topology, objects).features;
					for (var i = 0; i < geo.length; i++) {
						var stateId = +geo[i].id;
						var info = names.find((d) => d.id == stateId);
						if (!!info) {
							geo[i]["name"] = info.name;
							geo[i]["code"] = info.code;
						}
					}

					var svg = d3.select("svg"),
				        width = +svg.attr("width"),
				        height = +svg.attr("height");

				    var projection = d3.geoIdentity().scale(0.5);

					var calcPath = d3.geoPath().projection(projection);

					// render base map
					svg.append("g")
						.attr("class", "origin-map")
						.selectAll("path")
						.data(geo)
						.enter()
                			.append("path")
							.attr("d", calcPath)
							.style("fill", "tomato")
							.style("fill-opacity", 0.7)
							.style("stroke", "white");

					var geoGrid = d3g.geoGrid()
									  .width(width)
									  .height(height)
									  .spreadCoeff(1.5)
									  .projection(projection);

					var data = geoGrid(topology, objects);
					// render grid map
					var states = svg.append("g")
										.attr("class", "grid-map")
									.selectAll("g")
										.data(data.res).enter()
									.append("g")
										.attr("transform", (d) => `translate(${d.center[0] }, ${d.center[1]})`);
                	states
                		.append("circle")
							.attr("r", (d) => d.size / 2)
									.style("fill", "green")
									.style("fill-opacity", 0.7)
									.style("stroke", "white");
					states
						.append("text")
							.text((d) => {
								var info = names.find((n) => +d.id == +n.id);
								return info.code;
							})
							.style("text-anchor", "middle")
							.style("fill", "white")
							.style("font-family", "monospace")

					// render origin grid
					svg.append("g")
							.attr("class", "grid-map")
						.selectAll("circle")
						.data(data.grid).enter()
						.append("circle")
							.attr("cx", (x) => (x.center[0]))
							.attr("cy", (x) => (x.center[1]))
							.attr("r", (x) => (x.size/2))
								.style("fill", "yellow")
								.style("fill-opacity", 0.5);

					// render forced graph
					var graph = svg.append("g")
										.attr("class", "grid-map")
									.selectAll("g")
										.data(data.res).enter()
									.append("g")
										.attr("transform", (d) => `translate(${d.center[0] }, ${d.center[1]})`);

				});
		</script>
		
	</body>
</html>