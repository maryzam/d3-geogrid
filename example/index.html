<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		
		<style type="text/css"></style>

		<script src="https://d3js.org/d3.v5.js"></script>
		<script src="https://d3js.org/topojson.v2.min.js"></script>
		<script src="https://d3js.org/d3-geo.v1.min.js"></script>
		<script src="../build/d3-geogrid.js"></script>
	</head>
	<body>
		<svg width="480", height="300"></svg>
		<script type="text/javascript">
			
			Promise.all([
					d3.json("data/us-10m.v1.json"),
					d3.tsv("data/us-state-names.tsv")
				])
				.then(function(source) {
					var usa = source[0];
					var names = source[1];

					var geo = topojson.feature(usa, usa.objects.states).features;
					for (var i = 0; i < geo.length; i++) {
						var stateId = +geo[i].id;
						var info = names.find((d) => d.id == stateId);
						if (!!info) {
							geo[i]["name"] = info.name;
							geo[i]["code"] = info.code;
						}
					}

					var svg = d3.select("svg"),
				        width = +svg.attr("width"),
				        height = +svg.attr("height");

				    var projection = d3.geoIdentity().scale(0.5);

					var calcPath = d3.geoPath().projection(projection);

					// render base map
					svg.append("g")
						.attr("class", "origin-map")
						.selectAll("path")
						.data(geo)
						.enter()
                			.append("path")
							.attr("d", calcPath)
							.style("fill", "tomato")
							.style("fill-opacity", 0.7)
							.style("stroke", "white");

					var geoGrid = d3g.geoGrid()
									  .width(width)
									  .height(height)
									  .spreadCoeff(1.2)
									  .projection(projection);

					var outline = topojson.merge(usa, usa.objects.states.geometries);
					var data = geoGrid(geo, outline);

					var states = svg.append("g")
										.attr("class", "grid-map")
									.selectAll("g")
										.data(data).enter()
									.append("g")
										.attr("transform", (d) => `translate(${d.center[0]}, ${d.center[1]})`);
                	states
                		.append("rect")
							.attr("height", (d) => d.size)
							.attr("width", (d) => d.size)
									.style("fill", "green")
									.style("fill-opacity", 0.7)
									.style("stroke", "white");
					states
						.append("text")
							.text((d) => d.data.code)
							.attr("dy", (d) => d.size / 2 )
							.attr("dx", (d) => d.size / 2 )
							.style("text-anchor", "middle")
							.style("fill", "white")
							.style("font-family", "monospace")
				});
		</script>
		
	</body>
</html>